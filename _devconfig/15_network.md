---
layout: page_collection
title: How do I PIV enable my network logon?
collection: devconfig
permalink: devconfig/15_network/
---
<script>
$(function() {
  $( "#accordion" ).accordion({
    heightStyle: "content",
    collapsible: "true",
    active: "false"
  });
});
</script>


<div style="float:right; padding:10px; margin-right:20px; border-radius:10px; width:180px; height:40px; box-shadow:3px 3px 5px 0px; text-align:center; background-color:#CCC; color:#666666">
<div style="color:#000000">
<em>Difficulty: Advanced</em>
</div>
</div>

#### Overview
This guide will take you through the steps necessary to configure your Windows based computer network to accept and potentially require PIV cards for authentication.

##### Assumptions
*  Users have PIV cards
*  You're using Microsoft Active Directory to manage your Windows network users
*  Your Microsoft Windows Server versions are 2008 R2 or 2012
    *  Concepts will likely remain applicable to other versions of Windows Server, however, specific instructions may require modification

#### Before you get started
The following reference information may be useful or required for configuring your systems depending on your architecture. Some information will need to be obtained from the appropriate organization.

##### Ports and Protocols
*	 Kerberos : TCP 464 for Web Enrollment Servers to Domain Controllers
*  LDAP : TCP 389 for Web Enrollment to Domain Controllers
*  LDAP/S : TCP 636 for secure Web Enrollment to Domain Controllers
*  DCOM and RPC : Port Pool starts above 1023 for client certificate requests for internal users
*  HTTPS : TCP 443 for secure client certificate requests from external networks

##### Certification Authority Details
*  CA Certificate that signed the authentication certificates
    *  The Federal PKI [Federal Common Policy CA Certificate](http://http.fpki.gov/fcpca/fcpca.crt) - the root CA Certificate created by the Federal PKI Management Authority (FPKIMA)
    *  Subordinate CAs in the chain including the Certification Authority that issued the certificates - If your agency issues your certificates, it will be your agency's CA certificate. If your agency's certificates are generated by another organization, such as a managed service, you'll need to acquire it from them.
*  Certificate Revocation Lists (CRL)
    *  The FPKI
        *  [CRL over HTTP](http://http.fpki.gov/fcpca/fcpca.crl)
        *  [CRL over LDAP](ldap://ldap.fpki.gov/cn=Federal%20Common%20Policy%20CA,ou=FPKI,o=U.S. %20Government,c=US)
    *  The CRL of the Certification Authority that issued your agency's certificates.

<!-- *  Authority Information Access (AIA) Locations
    *  The FPKI
        *  [AIA over HTTP](http://http.fpki.gov/fcpca/caCertsIssuedTofcpca.p7c)
        *  [AIA over LDAP](ldap://ldap.fpki.gov/cn=Federal%20Common%20Policy%20CA,ou=FPKI,o=U.S. %20Government,c=US)
    *  The AIA of the Certification Authority that issued your agency's certificates. -->

#### Complete the following tasks
<div id="accordion" markdown="1">

### Add the CA Certificates to the Trusted Root Certification Authorities
<div markdown="1">

The root certificate and intermediate CA certs are required by the domain controller to establish a chain of trust between the parent CA and the end users and applications. This allows the domain controller to issue trusted certificates to PIV cards within the directory and confirm the validity of smart card certificates during an access attempt.

Active Directory must be configured to trust a certification authority to authenticate users based on certificates from that CA. Both Smartcard workstations and domain controllers must be configured with correctly configured certificates.

This task will configure Active Directory to trust the Certification Authority chain that signed the users' authentication certificates. To configure Active Directory with the signing CA Certificate chain:

1.	On your Active Directory Domain Controller server, select **Active Directory Users and Computers**
2.	In the **Management Console**, right click the **Domain** and click **Properties**
3.	Once you're on the **Group Policy Tab**, click **Open** to open the **Group Policy Management Console plug-in**
4.	Right Click **Default Domain Policy** and click **Edit**
5.	Expand the **Computer Configuration** section and open **Windows Settings > Security Settings > Public Key**
6.	Right click **Trusted Root Certification Authorities** and select **Import**
7.	Follow the prompts in the Wizard to import the **Root Certificate** for the CA and click OK

From here, follow these steps to import the intermediate certificate(s):

1.	Right click **Intermediate Certification Authorities** and select **Import**
2.	Follow the prompts in the Wizard to import the **Intermediate Certificate(s)** for the CA and click OK

</div>

### Request and install Domain Controller certificates
<div markdown="1">
Work with the Federal Public Key Infrastructure management team to request a domain controller certificate for your domain controller(s). Each domain controller that is going to authenticate smartcard users must have a domain controller certificate.  

##### The certificate for each domain controller must meet the following specific format requirements:

*  The certificate must have a CRL distribution-point extension that points to a valid certificate revocation list (CRL).
    *  Optionally, the certificate Subject section should contain the directory path of the server object (the distinguished name), for example:

			CN=controller1.agency.gov OU=Domain Controllers DC=agency DC=gov

    *  The certificate Key Usage section must contain:

            Digital Signature, Key Encipherment

    *  Optionally, the certificate Basic Constraints section should contain:

            [Subject Type=End Entity, Path Length Constraint=None]

    *  The certificate Enhanced Key Usage section must contain:

            Client Authentication (1.3.6.1.5.5.7.3.2)
            Server Authentication (1.3.6.1.5.5.7.3.1)

    *  The certificate Subject Alternative Name section must contain the Domain Name System (DNS) name. If SMTP replication is used, the certificate Subject Alternative Name section must also contain the globally unique identifier (GUID) of the domain controller object in the directory.
        *  To determine the Domain Controller GUID, start Ldp.exe and locate the domain-naming context. Double-click the name of the domain controller that you want to view. The list of attributes for that object contains "Object GUID" followed by a long number. The number is the GUID for that object. For example:

                Other Name: 1.3.6.1.4.1.311.25.1 = ac 4b 29 06 bb d6 5d 4f e3 9c 4c ab c3 6a 55 d9 DNS Name=controller1.agency.gov

    *  The certificate template must have an extension that has the BMP data value "DomainController."

            Note The dsstore.exe -dcmon command does not recognize the certificate without one of these extensions.

    *  You must use the Schannel cryptographic service provider (CSP) to generate the key.
*  The domain controller certificate must be installed in the local computer's certificate store.

##### Installing Domain Controller Certificates
The following procedure will install the domain controller certificate locally in the local system profile but not in Active Directory. To install the certificate on the target domain controller, perform the following steps with the Windows Server 2003 version of certreq and certutil.

1.	Log on to the target domain controller.
2.	Make the CER- and P7B-file from the previous section available to the domain controller.
3.	From a command-line prompt, run the following command. Replace _&lt;dcname&gt;_ with the name of the target domain controller. The command will not report any confirmation of success.

        CERTREQ -ACCEPT <dcname>.p7b

5.	Verify that the certificate has been installed in the local system personal certificate store by running the following command at a command-line prompt:

        certutil -viewstore My

8.  A window will appear that displays all certificates that are available in the local computer personal store.
7.	Log off your domain controller.

##### Publishing Domain Controller Certificates
A stand-alone CA is not capable of publishing certificates in Active Directory. However, SMTP replication requires the use of domain controller certificates published in Active Directory. For certificates that are enrolled asynchronously through an offline process, you must manually publish these certificates in Active Directory.
The following steps instruct you to examine the certificates that reside in the domain controller's local machine certificate store before the new certificate is published in Active Directory. The new certificate is published and you will be able to verify that the certificate was published properly.

Publishing certificates into computer objects in Active Directory requires write permissions for the _userCertificate_ attribute that is part of any computer object. Administrators and members of the built-in domain group "Cert Publishers" have this permission by default.

The _reqdccert.bat_ script creates a file called _&lt;dcname&gt;-vfy.bat_ that contains the correct _certutil_ command to verify the domain controller's certificate in Active Directory. You can use this batch file instead of typing the _certutil –viewstore_ commands manually as described in the following steps.
Perform the following steps to manually view and publish a domain controller certificate in Active Directory.

1.	Log on as domain administrator or a member of the Cert Publishers global group for the target domain controller. Technically, the publication can be performed at any computer that is a domain member, but for convenience, the domain controller is used in this scenario.
2.	Verify that there are no certificates already published on the domain controller's Active Directory object.
3.	Run the following command from a command-line prompt. Replace the <dcname> variable with the name of the target domain controller and <domainname> and <gov> variable names with the appropriate domain suffix.

        certutil -viewstore "ldap:///cn=<dcname>,ou=domain controllers,dc=<domainname>,dc=<gov>?usercertificate"

A window should appear with no certificates displayed. This is expected since no certificates have been published yet.

4.	Click Cancel to close the window.
5.	The certificate is published in Active Directory using the userCertificate attribute on the machine account object for the domain controller. Run the following command to write the certificate to the domain controller's Active Directory object. Replace the &lt;dcname&gt; variable with the name of the target domain controller.

        certutil –f –dspublish <dcname>.cer machine

The command determines the proper Active Directory object by the subject information in the certificate. The publication will fail if no object can be found based on the subject information.

6.	To verify that the certificate was published successfully, perform the following steps from a command-line prompt.

        certutil -viewstore "ldap:///cn=<dcname>,dc=<domainname>,dc=<gov>?usercertificate"

If the domain controller's computer object has no certificates in the userCertificate attribute, the certutil output will display an empty list in the window. If "?userCertificate" was omitted from the command line parameters or an invalid object class was specified, an error message will appear such as the following:

    CertUtil: -viewstore command FAILED: 0x80092009 (-2146885623)
    CertUtil: Cannot find the requested object.
    certutil –viewstore "ldap:///cn=Administrator,cn=Users,dc=<domainname>,dc=<gov>"


> When does a CA need to contact a writeable Domain Controller?
> A CA must contact a writeable domain controller (as opposed to a read-only domain controller, RODC) in the following circumstances:
>
> * When the CA reads templates, because it may need to add superseded domain controller templates to the CA object
> * When the CA queries user and computer objects, for example when retrieving alternative attributes for certificate mapping
> * If the CA is configured to publish a certificate revocation list (CRL) to LDAP.
> * If the CA issues a certificate that is configured to be published to Active Directory Domain Services (AD DS)
{:class="info"}

</div>

### Publish the CA Certificates to the NTAuth Store
<div markdown="1">

By publishing the CA certificate to the enterprise NTAuth store, the system administrator indicates that the CA is trusted to issue certain certificates. This allows the correct certificates to be issued to smartcards and thus enables logon through PIV card authentication.

This task will configure Active Directory to trust the CA chain that signed the users' authentication certificates. To configure Active Directory with the signing CA Certificate chain:

1.	On the Active Directory Domain Controller, launch an **elevated command prompt** to use the **certutil** utility
2.	To **Publish the Certificate** to the **Enterprise NTAuth store** type

        certutil –dpublish –f "path_to_root_CA_cert" NTAuthCA

3.	The CA is now trusted to issue certificates of this type

</div>

### Associate PIV Credentials with Active Directory Accounts (altSecurityIdentities)
<div markdown="1">

To configure Active Directory one-to-one mapping using altSecurityIdentities attributes:

1.	Click Start, click Programs, click Administrative Tools, and click Active Directory Users and Computers.
2.	Expand the domain name node containing the user(s) to manage and click the Users folder. In the right pane, right-click the account to map and click Name Mappings.
3.	On the X.509 Certificates tab, click the Add button. Select the user certificate from the .cer file that should be mapped to the account.
4.	The Use Issuer for alternate security identity will be selected and appear gray by default because you need to use this for both one-to-one mapping and many-to-one mapping. Select the Use Subject for alternate security identity option to do one-to-one mapping. By unchecking this option, you will be doing many-to-one mapping. Click OK.
5.	Go to the section, testing the Mapping, to verify that this works.

</div>

### Configure group policies for PIV Authentication
<div markdown="1">

This task describes 2 common configurations related to domain Group Policy Objects (GPO).

|  scforceoption  |  This security policy setting requires users to log on to a computer by using a smart card.  |  Enabled / Disabled  |
|  scremoveoption  |  This setting determines what happens when the smart card for a logged-on user is removed from the smart card reader.  |  No Action / Lock Workstation / Force Logoff / Disconnect if a Remote Desktop Services session  |

**scforceoption** directs client Windows computers to enforce PIV logon for users. It is important to understand the ramifications of executing this step.

When you select the Smart Card is required for interactive logon check box in the Active Directory (AD) user account properties, Windows automatically resets the user password to a random complex password. In addition, Windows adds the SMARTCARD_REQUIRED flag to the UserAccountControl user account attribute and sets the DONT_EXPIRE_PASSWORD flag on the user account. The latter ensures that the user's password never expires after the Smart Card is required for interactive logon option is selected.

When a user logs on to Windows either locally or remotely using a Remote Desktop session, the Windows client automatically checks for the presence of the SMARTCARD_REQUIRED flag. If the Smart Card is required for interactive logon option is set for the user, Windows rejects the logon attempt if it's not made with smart card credentials.

Again, upon activation of scforceoption, users will **no longer know the password** to their account and will be **required** to use their PIV for authentication. Care should be used if enabling this option.

To enable or disable either of these policies:

1.  Open the Group Policy Management Console
1.  In the GPMC console tree, double-click Group Policy Objects in the forest and domain containing the GPO that you want to edit.
1.  Right-click the GPO, and then click Edit.
1.  In the console tree, edit the settings as appropriate.

</div>
</div>

#### References

Elements of this guide were derived from a [Microsoft Knowledgebase Article](https://support.microsoft.com/en-us/kb/281245)
